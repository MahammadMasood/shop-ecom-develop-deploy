<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link rel="stylesheet" href="/static/styles.css" />
  </head>
  <body>
    <header>
      <div><strong>Mini Shop</strong> – Admin</div>
      <nav>
        <a href="./index.html">Home</a>
      </nav>
    </header>
    <div class="container">
      <div class="card">
        <h3>Admin Login (token)</h3>
        <div class="form-group">
          <label>Token (set ADMIN_TOKEN env var on backend)</label>
          <input id="token" placeholder="changemeadmin" />
        </div>
        <button class="btn" onclick="saveToken()">Save Token</button>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3>Add / Edit Product</h3>
        <div class="form-group">
          <label>Product ID (leave empty to create)</label>
          <input id="product-id" />
        </div>
        <div class="form-group">
          <label>Name</label>
          <input id="product-name" />
        </div>
        <div class="form-group">
          <label>Price</label>
          <input id="product-price" type="number" step="0.01" />
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="product-description"></textarea>
        </div>
        <div class="form-group">
          <label>Image URL</label>
          <input id="product-image" />
        </div>
        <div class="form-group">
          <label>Upload Image (optional)</label>
          <input id="product-image-file" type="file" accept="image/*" />
          <small>Tip: Save product first to get an ID, then upload.</small>
        </div>
        <div class="form-group">
          <label>Stock</label>
          <input id="product-stock" type="number" />
        </div>
        <button class="btn" onclick="saveProduct()">Save</button>
        <button class="btn secondary" onclick="uploadImage()">Upload Image</button>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3>Products</h3>
        <div id="product-list"></div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3>Orders</h3>
        <div id="orders"></div>
      </div>

      <div class="card" style="margin-top:16px;">
        <h3>Daily Orders</h3>
        <div id="analytics"></div>
      </div>
    </div>

    <script>
      const API_BASE = `${window.location.origin}/api`;
      const saved = localStorage.getItem("admin_token");
      if (saved) document.getElementById("token").value = saved;

      function getHeaders() {
        return {
          "Content-Type": "application/json",
          "X-Admin-Token": localStorage.getItem("admin_token") || "",
        };
      }

      function saveToken() {
        localStorage.setItem("admin_token", document.getElementById("token").value);
        alert("Token saved");
        loadAll();
      }

      async function saveProduct() {
        const id = document.getElementById("product-id").value;
        const body = {
          name: document.getElementById("product-name").value,
          price: Number(document.getElementById("product-price").value || 0),
          description: document.getElementById("product-description").value,
          image_url: document.getElementById("product-image").value,
          stock: Number(document.getElementById("product-stock").value || 0),
        };
        const method = id ? "PATCH" : "POST";
        const url = id ? `${API_BASE}/products/${id}/` : `${API_BASE}/products/`;
        const res = await fetch(url, {
          method,
          credentials: "include",
          headers: getHeaders(),
          body: JSON.stringify(body),
        });
        if (!res.ok) {
          alert("Save failed");
          return;
        }
        const savedProduct = await res.json();
        // Keep ID in the form so image upload can work.
        document.getElementById("product-id").value = savedProduct.id;
        loadProducts();
      }

      async function uploadImage() {
        const id = document.getElementById("product-id").value;
        const fileInput = document.getElementById("product-image-file");
        if (!id) {
          alert("Save the product first (so it has an ID), then upload an image.");
          return;
        }
        if (!fileInput.files || !fileInput.files[0]) {
          alert("Choose an image file first.");
          return;
        }
        const form = new FormData();
        form.append("image", fileInput.files[0]);

        const res = await fetch(`${API_BASE}/products/${id}/upload-image/`, {
          method: "POST",
          credentials: "include",
          headers: { "X-Admin-Token": localStorage.getItem("admin_token") || "" },
          body: form,
        });
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          alert(err.detail || "Upload failed");
          return;
        }
        alert("Image uploaded");
        loadProducts();
      }

      function clearForm() {
        document.getElementById("product-id").value = "";
        document.getElementById("product-name").value = "";
        document.getElementById("product-price").value = "";
        document.getElementById("product-description").value = "";
        document.getElementById("product-image").value = "";
        document.getElementById("product-stock").value = "";
        document.getElementById("product-image-file").value = "";
      }

      function editProduct(p) {
        document.getElementById("product-id").value = p.id;
        document.getElementById("product-name").value = p.name;
        document.getElementById("product-price").value = p.price;
        document.getElementById("product-description").value = p.description;
        document.getElementById("product-image").value = p.image_url;
        document.getElementById("product-stock").value = p.stock;
      }

      async function deleteProduct(id) {
        await fetch(`${API_BASE}/products/${id}/`, {
          method: "DELETE",
          credentials: "include",
          headers: getHeaders(),
        });
        loadProducts();
      }

      async function loadProducts() {
        const res = await fetch(`${API_BASE}/products/`, { credentials: "include" });
        const items = await res.json();
        window.productsCache = items;
        const container = document.getElementById("product-list");
        container.innerHTML = "";
        items.forEach((p) => {
          const row = document.createElement("div");
          row.style.display = "flex";
          row.style.justifyContent = "space-between";
          row.style.alignItems = "center";
          row.style.padding = "6px 0";
          row.innerHTML = `
            <span>${p.name} - $${p.price.toFixed(2)} (stock: ${p.stock})</span>
            <span>
              <button class="btn secondary" onclick='editProductById(${p.id})'>Edit</button>
              <button class="btn danger" onclick="deleteProduct(${p.id})">Delete</button>
            </span>
          `;
          container.appendChild(row);
        });
      }

      function editProductById(id) {
        const product = (window.productsCache || []).find((p) => p.id === id);
        if (product) editProduct(product);
      }

      async function loadOrders() {
        const res = await fetch(`${API_BASE}/orders/`, {
          credentials: "include",
          headers: getHeaders(),
        });
        const data = await res.json();
        const container = document.getElementById("orders");
        container.innerHTML = "";
        data.forEach((o) => {
          const card = document.createElement("div");
          card.style.borderBottom = "1px solid #e5e7eb";
          card.style.padding = "8px 0";
          card.innerHTML = `
            <strong>${o.order_id}</strong> — ${o.customer_name} (${o.customer_email})<br>
            Status: ${o.status} | Total: $${o.total.toFixed(2)}<br>
            Items: ${o.items.map((i) => `${i.product_name} x${i.quantity}`).join(", ")}
          `;
          container.appendChild(card);
        });
      }

      async function loadAnalytics() {
        const res = await fetch(`${API_BASE}/analytics/daily-orders/`, {
          credentials: "include",
          headers: getHeaders(),
        });
        const data = await res.json();
        const container = document.getElementById("analytics");
        container.innerHTML = data
          .map((d) => `<div>${d.date}: <strong>${d.orders}</strong> orders</div>`)
          .join("");
      }

      function loadAll() {
        loadProducts();
        loadOrders();
        loadAnalytics();
      }

      loadAll();
    </script>
  </body>
</html>

